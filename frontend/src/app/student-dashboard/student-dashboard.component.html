<div class="student-dashboard">
  <!-- Encabezado -->
  <header class="dashboard-header">
    <div class="header-content">
      <h1>Consultorio M√©dico</h1>
      <div class="user-info">
  <span>Bienvenido, {{ studentName }}</span>
  <button class="logout-btn" (click)="logout()">Cerrar Sesi√≥n</button>
</div>
    </div>
    
    <!-- Navegaci√≥n -->
    <nav class="dashboard-nav">
      <button 
        [class.active]="activeSection === 'inicio'" 
        (click)="setActiveSection('inicio')"
        class="nav-button">
        Inicio
      </button>
      <button 
        [class.active]="activeSection === 'citas'" 
        (click)="setActiveSection('citas')"
        class="nav-button">
        Citas
      </button>
      <button 
        [class.active]="activeSection === 'bitacora'" 
        (click)="setActiveSection('bitacora')"
        class="nav-button">
        Bit√°cora
      </button>
      <button 
        [class.active]="activeSection === 'recetas'" 
        (click)="setActiveSection('recetas')"
        class="nav-button">
        Recetas
      </button>
    </nav>
  </header>

  <!-- Contenido Principal -->
  <main class="dashboard-content">
    
    <!-- Secci√≥n: Inicio -->
    <section *ngIf="activeSection === 'inicio'" class="content-section">
      <div class="welcome-card">
        <h2>Bienvenido al Sistema del Consultorio</h2>
        <p>Hola {{ studentName }}, aqu√≠ puedes gestionar tus citas m√©dicas y revisar tu historial.</p>
        
        <div class="quick-stats">
          <div class="stat-card">
            <h3>Pr√≥xima Cita</h3>
            <ng-container *ngIf="nextCitaInfo; else noProximaCita">
              <p class="stat-value">{{ nextCitaInfo.fecha }}</p>
              <p class="stat-detail">{{ nextCitaInfo.hora }} hrs</p>
              <p class="stat-detail" *ngIf="nextCitaInfo.motivo">Motivo: {{ nextCitaInfo.motivo }}</p>
            </ng-container>
            <ng-template #noProximaCita>
              <p class="stat-value">No tienes citas programadas</p>
            </ng-template>
          </div>
          <div class="stat-card">
            <h3>Citas Programadas</h3>
            <p class="stat-value">{{ totalCitasProgramadas }} {{ totalCitasProgramadas === 1 ? 'cita' : 'citas' }}</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Secci√≥n: Citas -->
    <section *ngIf="activeSection === 'citas'" class="content-section">
      <div class="section-header">
        <h2>Gesti√≥n de Citas</h2>
        <button class="btn-primary" (click)="toggleCreateForm()">
          {{ showCreateForm ? 'Cerrar formulario' : 'Agendar Nueva Cita' }}
        </button>
      </div>

      <div *ngIf="submitMessage" class="alert">
        {{ submitMessage }}
      </div>

      <div *ngIf="showCreateForm" class="form-card">
        <form #createCitaForm="ngForm" (ngSubmit)="onCreateCita(createCitaForm)">
          <div class="form-grid">
            <div class="form-group full-width">
              <label>Fecha de la cita</label>
              <div class="calendar-card">
                <div class="calendar-header">
                  <button type="button" class="calendar-nav" (click)="changeMonth(-1)">‚Äπ</button>
                  <h4>{{ calendarLabel | titlecase }}</h4>
                  <button type="button" class="calendar-nav" (click)="changeMonth(1)">‚Ä∫</button>
                </div>
                <div class="calendar-legend">
                  <span><span class="dot available"></span> Disponible</span>
                  <span><span class="dot partial"></span> Parcial</span>
                  <span><span class="dot full"></span> Sin lugares</span>
                </div>
                <div class="calendar-weekdays">
                  <span *ngFor="let day of weekDays">{{ day }}</span>
                </div>
                <div class="calendar-grid">
                  <ng-container *ngFor="let week of calendarWeeks">
                    <button
                      type="button"
                      *ngFor="let day of week"
                      class="calendar-day"
                      [ngClass]="{
                        outside: !day.isCurrentMonth,
                        today: day.isToday,
                        selected: isSelectedDate(day.date),
                        unavailable: isDayUnavailable(day),
                        'status-available': day.availability === 'available',
                        'status-partial': day.availability === 'partial',
                        'status-full': day.availability === 'full',
                        'status-none': day.availability === 'none'
                      }"
                      [ngStyle]="getDayStyle(day)"
                      [attr.aria-pressed]="isSelectedDate(day.date)"
                      (click)="selectCalendarDay(day)"
                    >
                      <span class="day-number">{{ day.label }}</span>
                      <span class="day-badge" *ngIf="day.labelText">{{ day.labelText }}</span>
                    </button>
                  </ng-container>
                </div>
              </div>
              <div class="selected-date-info" *ngIf="createFormData.fecha_cita">
                <strong>Seleccionaste:</strong> {{ formatDateDisplay(createFormData.fecha_cita) }}
              </div>
              <input
                type="hidden"
                name="fecha_cita"
                [(ngModel)]="createFormData.fecha_cita"
                required
              />
            </div>

            <div class="form-group full-width">
              <label>Hora</label>
              <div class="time-slots" [class.disabled]="!createFormData.fecha_cita || !hasAvailableSlotsForSelectedDate">
                <button
                  type="button"
                  class="slot-button"
                  *ngFor="let slot of timeSlots"
                  [class.selected]="createFormData.hora_cita === normalizeTime(slot)"
                  [class.booked]="isSlotUnavailable(slot)"
                  [disabled]="!createFormData.fecha_cita || isSlotUnavailable(slot)"
                  (click)="selectTimeSlot(slot)"
                >
                  {{ formatTime(slot) }}
                </button>
              </div>
              <small class="helper-text" *ngIf="!createFormData.fecha_cita">
                Selecciona un d√≠a disponible en el calendario para ver las horas libres.
              </small>
              <small class="helper-text warning" *ngIf="createFormData.fecha_cita && !hasAvailableSlotsForSelectedDate">
                Este d√≠a ya est√° lleno. Elige otra fecha.
              </small>
              <small class="helper-text" *ngIf="createFormData.fecha_cita && hasAvailableSlotsForSelectedDate">
                Horario disponible de 7:00 a 21:00 hrs en bloques de 15 minutos.
              </small>
              <input
                type="hidden"
                name="hora_cita"
                [(ngModel)]="createFormData.hora_cita"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label for="motivo">Motivo</label>
            <textarea
              id="motivo"
              name="motivo"
              [(ngModel)]="createFormData.motivo"
              rows="3"
              placeholder="Describe brevemente tu motivo"
              class="motivo-area"
            ></textarea>
          </div>

          <button class="btn-primary" type="submit" [disabled]="isSubmitting || createCitaForm.invalid">
            {{ isSubmitting ? 'Agendando...' : 'Guardar cita' }}
          </button>
        </form>
      </div>

      <div class="citas-container">
        <ng-container *ngIf="!isLoadingCitas; else loadingCitas">
          <div *ngIf="citasError" class="alert error">{{ citasError }}</div>

          <div class="citas-layout" *ngIf="!citasError">
            <div class="citas-column pendientes">
              <h3>Pr√≥ximas citas</h3>

              <ng-container *ngIf="pendingCitas.length > 0; else noPendientes">
                <div *ngFor="let cita of pendingCitas" class="cita-card">
                  <div class="cita-header">
                    <h4>{{ formatDateDisplay(cita.fecha_cita) }}</h4>
                    <span class="estatus programada">Pendiente</span>
                  </div>
                  <p class="hora">{{ formatTime(cita.hora_cita) }} hrs</p>
                  <p class="motivo" *ngIf="cita.motivo">Motivo: {{ cita.motivo }}</p>
                  <p class="doctor" *ngIf="cita.doctor">Doctor asignado: {{ cita.doctor.nombre }} {{ cita.doctor.apellido }}</p>

                  <div class="card-actions">
                    <button class="btn-secondary" (click)="onCancelCita(cita)" [disabled]="isSubmitting">
                      {{ isSubmitting ? 'Cancelando...' : 'Cancelar cita' }}
                    </button>
                  </div>
                </div>
              </ng-container>
              <ng-template #noPendientes>
                <div class="placeholder-card compact">
                  <h4>No tienes citas pendientes</h4>
                  <p>Agenda una nueva cita para verla aqu√≠.</p>
                </div>
              </ng-template>
            </div>

            <div class="citas-column historial">
              <h3>Historial reciente</h3>

              <ng-container *ngIf="handledCitas.length > 0; else noHistorial">
                <div *ngFor="let cita of handledCitas" class="cita-card" [class.cancelada]="cita.estatus === 'cancelada'">
                  <div class="cita-header">
                    <h4>{{ formatDateDisplay(cita.fecha_cita) }}</h4>
                    <span class="estatus"
                          [class.atendida]="cita.estatus === 'atendida'"
                          [class.cancelada]="cita.estatus === 'cancelada'">
                      {{ cita.estatus === 'atendida' ? 'Atendida' : 'Cancelada' }}
                    </span>
                  </div>
                  <p class="hora">{{ formatTime(cita.hora_cita) }} hrs</p>
                  <p class="motivo" *ngIf="cita.motivo">Motivo: {{ cita.motivo }}</p>
                  <p class="doctor" *ngIf="cita.doctor">Doctor asignado: {{ cita.doctor.nombre }} {{ cita.doctor.apellido }}</p>
                </div>
              </ng-container>
              <ng-template #noHistorial>
                <div class="placeholder-card compact">
                  <h4>Sin registros todav√≠a</h4>
                  <p>Cuando atiendas o canceles citas aparecer√°n aqu√≠.</p>
                </div>
              </ng-template>
            </div>
          </div>
        </ng-container>
        <ng-template #loadingCitas>
          <div class="placeholder-card">Cargando tus citas...</div>
        </ng-template>
      </div>
    </section>

    <!-- Secci√≥n: Bit√°cora -->
    <section *ngIf="activeSection === 'bitacora'" class="content-section">
      <div class="section-header">
        <h2>Bit√°cora M√©dica</h2>
      </div>
      
      <div class="bitacora-container">
        <ng-container *ngIf="!isLoadingBitacoras; else loadingBitacoras">
          <div *ngIf="bitacorasError" class="alert error">{{ bitacorasError }}</div>

          <div *ngIf="!bitacorasError && bitacoras.length === 0" class="placeholder-card">
            <h3>A√∫n no tienes registros m√©dicos</h3>
            <p>Cuando el doctor registre una consulta, ver√°s aqu√≠ el resumen de tu atenci√≥n.</p>
          </div>

          <div *ngIf="bitacoras.length > 0" class="cards-grid">
            <div *ngFor="let bitacora of bitacoras" class="bitacora-card">
              <div class="bitacora-header">
                <h3>{{ bitacora.doctor?.nombre }} {{ bitacora.doctor?.apellido }}</h3>
                <span class="bitacora-date">{{ formatBitacoraDate(bitacora.created_at) }}</span>
              </div>
              <p class="bitacora-detail"><strong>Cita:</strong> {{ formatDateDisplay(bitacora.cita?.fecha_cita || '') }} ¬∑ {{ bitacora.cita?.hora_cita }} hrs</p>
              <p class="bitacora-detail" *ngIf="bitacora.diagnostico"><strong>Diagn√≥stico:</strong> {{ bitacora.diagnostico }}</p>
              <p class="bitacora-detail" *ngIf="bitacora.tratamiento"><strong>Tratamiento:</strong> {{ bitacora.tratamiento }}</p>
              <p class="bitacora-detail" *ngIf="bitacora.observaciones"><strong>Observaciones:</strong> {{ bitacora.observaciones }}</p>

              <div class="bitacora-metrics">
                <span *ngIf="bitacora.peso">‚öñÔ∏è Peso: {{ bitacora.peso }}</span>
                <span *ngIf="bitacora.altura">üìè Altura: {{ bitacora.altura }}</span>
                <span *ngIf="bitacora.temperatura">üå°Ô∏è Temp: {{ bitacora.temperatura }}</span>
                <span *ngIf="bitacora.presion_arterial">ü©∫ Presi√≥n: {{ bitacora.presion_arterial }}</span>
              </div>
            </div>
          </div>
        </ng-container>
        <ng-template #loadingBitacoras>
          <div class="placeholder-card">Cargando tu historial m√©dico...</div>
        </ng-template>
      </div>
    </section>

    <!-- Secci√≥n: Recetas -->
    <section *ngIf="activeSection === 'recetas'" class="content-section">
      <div class="section-header">
        <h2>Mis Recetas M√©dicas</h2>
      </div>

      <div class="recetas-container">
        <ng-container *ngIf="!isLoadingRecetas; else loadingRecetas">
          <div *ngIf="recetasError" class="alert error">{{ recetasError }}</div>

          <div *ngIf="!recetasError && recetas.length === 0" class="placeholder-card">
            <h3>No tienes recetas registradas</h3>
            <p>Cuando el doctor expida una receta para ti aparecer√° en este apartado.</p>
          </div>

          <div *ngIf="recetas.length > 0" class="cards-grid">
            <div *ngFor="let receta of recetas" class="receta-card">
              <div class="receta-header">
                <h3>{{ receta.doctor?.nombre }} {{ receta.doctor?.apellido }}</h3>
                <span class="receta-date">Emitida el {{ formatRecetaDate(receta.fecha_emision) }}</span>
              </div>
              <p class="receta-detail"><strong>Cita asociada:</strong> {{ formatDateDisplay(receta.cita?.fecha_cita || '') }} ¬∑ {{ receta.cita?.hora_cita }} hrs</p>
              <p class="receta-detail"><strong>Medicamentos:</strong></p>
              <p class="receta-text">{{ receta.medicamentos }}</p>
              <p class="receta-detail" *ngIf="receta.indicaciones"><strong>Indicaciones:</strong></p>
              <p class="receta-text" *ngIf="receta.indicaciones">{{ receta.indicaciones }}</p>
            </div>
          </div>
        </ng-container>
        <ng-template #loadingRecetas>
          <div class="placeholder-card">Cargando tus recetas...</div>
        </ng-template>
      </div>
    </section>

  </main>
</div>