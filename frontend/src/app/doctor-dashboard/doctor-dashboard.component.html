<div class="doctor-dashboard">
  <!-- Encabezado -->
  <header class="dashboard-header">
    <div class="header-content">
      <h1>Consultorio M√©dico</h1>
      <div class="user-info">
        <span>Bienvenido, {{ doctorName }}</span>
        <button class="logout-btn" (click)="logout()">Cerrar Sesi√≥n</button>
      </div>
    </div>
    
    <!-- Navegaci√≥n -->
    <nav class="dashboard-nav">
      <button 
        [class.active]="activeSection === 'inicio'" 
        (click)="setActiveSection('inicio')"
        class="nav-button">
        Inicio
      </button>
      <button 
        [class.active]="activeSection === 'citas'" 
        (click)="setActiveSection('citas')"
        class="nav-button">
        Citas
      </button>
      <button 
        [class.active]="activeSection === 'bitacoras'" 
        (click)="setActiveSection('bitacoras')"
        class="nav-button">
        Bit√°coras
      </button>
      <button 
        [class.active]="activeSection === 'recetas'" 
        (click)="setActiveSection('recetas')"
        class="nav-button">
        Recetas
      </button>
    </nav>
  </header>

  <!-- Contenido Principal -->
  <main class="dashboard-content">
    
    <!-- Secci√≥n: Inicio -->
    <section *ngIf="activeSection === 'inicio'" class="content-section">
      <div class="welcome-card">
        <h2>Panel del Doctor</h2>
        <p>Bienvenido {{ doctorName }}, desde aqu√≠ puedes gestionar tus consultas, pacientes y registros m√©dicos.</p>
        
        <div class="quick-stats">
          <div class="stat-card">
            <h3>Citas del D√≠a</h3>
            <p class="stat-value">{{ todayAppointments }}</p>
            <p class="stat-detail">Programadas para hoy</p>
          </div>
          <div class="stat-card">
            <h3>Pacientes Atendidos</h3>
            <p class="stat-value">{{ patientsAttended }}</p>
            <p class="stat-detail">Historial reciente</p>
          </div>
          <div class="stat-card">
            <h3>Citas Pendientes</h3>
            <p class="stat-value">{{ pendingBitacoras }}</p>
            <p class="stat-detail">Requieren atenci√≥n</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Secci√≥n: Citas -->
    <section *ngIf="activeSection === 'citas'" class="content-section">
      <div class="section-header">
        <h2>Gesti√≥n de Citas</h2>
        <button class="btn-primary" (click)="toggleCreateForm()">
          {{ showCreateForm ? 'Cerrar formulario' : 'Agendar Nueva Cita' }}
        </button>
      </div>

      <div *ngIf="submitMessage" class="alert">
        {{ submitMessage }}
      </div>

      <div *ngIf="showCreateForm" class="form-card">
        <form #createCitaForm="ngForm" (ngSubmit)="onCreateCita(createCitaForm)">
          <div class="form-grid">
            <div class="form-group">
              <label for="numeroControl">N√∫mero de control del alumno</label>
              <input
                type="text"
                id="numeroControl"
                name="numero_control"
                [(ngModel)]="createFormData.numero_control"
                required
                placeholder="Ej. A12345678"
              />
            </div>
            <div class="form-group full-width">
              <label>Fecha de la cita</label>
              <div class="calendar-card">
                <div class="calendar-header">
                  <button type="button" class="calendar-nav" (click)="changeMonth(-1)">‚Äπ</button>
                  <h4>{{ calendarLabel | titlecase }}</h4>
                  <button type="button" class="calendar-nav" (click)="changeMonth(1)">‚Ä∫</button>
                </div>
                <div class="calendar-legend">
                  <span><span class="dot available"></span> Disponible</span>
                  <span><span class="dot partial"></span> Parcial</span>
                  <span><span class="dot full"></span> Sin lugares</span>
                </div>
                <div class="calendar-weekdays">
                  <span *ngFor="let day of weekDays">{{ day }}</span>
                </div>
                <div class="calendar-grid">
                  <ng-container *ngFor="let week of calendarWeeks">
                    <button
                      type="button"
                      *ngFor="let day of week"
                      class="calendar-day"
                      [ngClass]="{
                        outside: !day.isCurrentMonth,
                        today: day.isToday,
                        selected: isSelectedDate(day.date),
                        unavailable: isDayUnavailable(day),
                        'status-available': day.availability === 'available',
                        'status-partial': day.availability === 'partial',
                        'status-full': day.availability === 'full',
                        'status-none': day.availability === 'none'
                      }"
                      [ngStyle]="getDayStyle(day)"
                      [attr.aria-pressed]="isSelectedDate(day.date)"
                      (click)="selectCalendarDay(day)"
                    >
                      <span class="day-number">{{ day.label }}</span>
                      <span class="day-badge" *ngIf="day.labelText">{{ day.labelText }}</span>
                    </button>
                  </ng-container>
                </div>
              </div>
              <div class="selected-date-info" *ngIf="createFormData.fecha_cita">
                <strong>Seleccionaste:</strong> {{ formatDateDisplay(createFormData.fecha_cita) }}
              </div>
              <input
                type="hidden"
                id="fechaCita"
                name="fecha_cita"
                [(ngModel)]="createFormData.fecha_cita"
                required
              />
            </div>
            <div class="form-group full-width">
              <label>Hora</label>
              <div class="time-slots" [class.disabled]="!createFormData.fecha_cita || !hasAvailableSlotsForSelectedDate">
                <button
                  type="button"
                  class="slot-button"
                  *ngFor="let slot of timeSlots"
                  [class.selected]="createFormData.hora_cita === normalizeTime(slot)"
                  [class.booked]="isSlotUnavailable(slot)"
                  [disabled]="!createFormData.fecha_cita || isSlotUnavailable(slot)"
                  (click)="selectTimeSlot(slot)"
                >
                  {{ formatTime(slot) }}
                </button>
              </div>
              <small class="helper-text" *ngIf="!createFormData.fecha_cita">
                Selecciona un d√≠a disponible para ver las horas libres.
              </small>
              <small class="helper-text warning" *ngIf="createFormData.fecha_cita && !hasAvailableSlotsForSelectedDate">
                Este d√≠a ya no tiene espacios disponibles.
              </small>
              <input
                type="hidden"
                id="horaCita"
                name="hora_cita"
                [(ngModel)]="createFormData.hora_cita"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label for="motivo">Motivo</label>
            <textarea
              id="motivo"
              name="motivo"
              [(ngModel)]="createFormData.motivo"
              rows="3"
              placeholder="Describe el motivo de la consulta"
            ></textarea>
          </div>

          <button class="btn-primary" type="submit" [disabled]="isSubmitting || createCitaForm.invalid">
            {{ isSubmitting ? 'Agendando...' : 'Guardar cita' }}
          </button>
        </form>
      </div>

      <div class="citas-container">
        <ng-container *ngIf="!isLoadingCitas; else loadingCitas">
          <div *ngIf="citasError" class="alert error">{{ citasError }}</div>

          <div class="citas-layout" *ngIf="!citasError">
            <div class="citas-column pendientes">
              <h3>Pr√≥ximas citas</h3>

              <ng-container *ngIf="pendingCitas.length > 0; else noPendientesDoctor">
                <div *ngFor="let cita of pendingCitas" class="cita-card">
                  <div class="cita-header">
                    <h4>{{ formatDateDisplay(cita.fecha_cita) }}</h4>
                    <span class="estatus programada">Programada</span>
                  </div>
                  <p class="hora">{{ formatTime(cita.hora_cita) }} hrs</p>
                  <p class="motivo" *ngIf="cita.motivo">Motivo: {{ cita.motivo }}</p>
                  <p class="alumno" *ngIf="cita.alumno">Alumno: {{ cita.alumno.nombre }} {{ cita.alumno.apellido }}</p>

                  <div class="card-actions">
                    <button
                      class="btn-secondary"
                      (click)="onCancelCita(cita)"
                      [disabled]="isSubmitting"
                    >
                      {{ isSubmitting ? 'Cancelando...' : 'Cancelar cita' }}
                    </button>
                    <button
                      class="btn-primary"
                      (click)="onMarkAsAttended(cita)"
                      [disabled]="isSubmitting"
                    >
                      {{ isSubmitting ? 'Procesando...' : 'Marcar atendida' }}
                    </button>
                  </div>
                </div>
              </ng-container>
              <ng-template #noPendientesDoctor>
                <div class="placeholder-card compact">
                  <h4>No hay citas pendientes</h4>
                  <p>Cuando agendes citas para los alumnos aparecer√°n aqu√≠.</p>
                </div>
              </ng-template>
            </div>

            <div class="citas-column historial">
              <h3>Historial reciente</h3>

              <ng-container *ngIf="handledCitas.length > 0; else noHistorialDoctor">
                <div
                  *ngFor="let cita of handledCitas"
                  class="cita-card"
                  [class.cancelada]="cita.estatus === 'cancelada'"
                >
                  <div class="cita-header">
                    <h4>{{ formatDateDisplay(cita.fecha_cita) }}</h4>
                    <span
                      class="estatus"
                      [class.atendida]="cita.estatus === 'atendida'"
                      [class.cancelada]="cita.estatus === 'cancelada'"
                    >
                      {{ cita.estatus === 'atendida' ? 'Atendida' : 'Cancelada' }}
                    </span>
                  </div>
                  <p class="hora">{{ formatTime(cita.hora_cita) }} hrs</p>
                  <p class="motivo" *ngIf="cita.motivo">Motivo: {{ cita.motivo }}</p>
                  <p class="alumno" *ngIf="cita.alumno">Alumno: {{ cita.alumno.nombre }} {{ cita.alumno.apellido }}</p>
                </div>
              </ng-container>
              <ng-template #noHistorialDoctor>
                <div class="placeholder-card compact">
                  <h4>Sin historial todav√≠a</h4>
                  <p>Cuando atiendas o canceles citas aparecer√°n en esta secci√≥n.</p>
                </div>
              </ng-template>
            </div>
          </div>
        </ng-container>
        <ng-template #loadingCitas>
          <div class="placeholder-card">Cargando lista de citas...</div>
        </ng-template>
      </div>
    </section>

    <!-- Secci√≥n: Bit√°coras -->
    <section *ngIf="activeSection === 'bitacoras'" class="content-section">
      <div class="section-header">
        <h2>Bit√°coras M√©dicas</h2>
        <button class="btn-primary" (click)="toggleBitacoraForm()">
          {{ showBitacoraForm ? 'Cerrar formulario' : 'Registrar Bit√°cora' }}
        </button>
      </div>

      <div *ngIf="bitacoraMessage" class="alert">
        {{ bitacoraMessage }}
      </div>

      <div *ngIf="showBitacoraForm" class="form-card">
        <form #bitacoraForm="ngForm" (ngSubmit)="onCreateBitacora(bitacoraForm)">
          <div class="form-grid">
            <div class="form-group">
              <label for="citaAsociada">Cita atendida</label>
              <select
                id="citaAsociada"
                name="cita_id"
                [(ngModel)]="bitacoraFormData.cita_id"
                required
                [disabled]="editingBitacoraId !== null"
              >
                <option value="" disabled selected>Selecciona una cita atendida</option>
                <option *ngFor="let cita of availableCitasForBitacora" [value]="cita.id">
                  {{ formatDateDisplay(cita.fecha_cita) }} - {{ cita.hora_cita }} hrs ({{ cita.alumno?.nombre }} {{ cita.alumno?.apellido }})
                </option>
              </select>
            </div>
            <div class="form-group">
              <label for="diagnostico">Diagn√≥stico</label>
              <textarea
                id="diagnostico"
                name="diagnostico"
                [(ngModel)]="bitacoraFormData.diagnostico"
                rows="2"
                required
                placeholder="Describe el diagn√≥stico"
              ></textarea>
            </div>
            <div class="form-group">
              <label for="tratamiento">Tratamiento</label>
              <textarea
                id="tratamiento"
                name="tratamiento"
                [(ngModel)]="bitacoraFormData.tratamiento"
                rows="2"
                required
                placeholder="Describe el tratamiento"
              ></textarea>
            </div>
          </div>

          <div class="form-grid small-grid">
            <div class="form-group">
              <label for="peso">Peso</label>
              <input
                type="text"
                id="peso"
                name="peso"
                [(ngModel)]="bitacoraFormData.peso"
                required
                placeholder="Ej. 70 kg"
              />
            </div>
            <div class="form-group">
              <label for="altura">Altura</label>
              <input
                type="text"
                id="altura"
                name="altura"
                [(ngModel)]="bitacoraFormData.altura"
                required
                placeholder="Ej. 1.70 m"
              />
            </div>
            <div class="form-group">
              <label for="temperatura">Temperatura</label>
              <input
                type="text"
                id="temperatura"
                name="temperatura"
                [(ngModel)]="bitacoraFormData.temperatura"
                required
                placeholder="Ej. 36.5 ¬∞C"
              />
            </div>
            <div class="form-group">
              <label for="presion">Presi√≥n arterial</label>
              <input
                type="text"
                id="presion"
                name="presion_arterial"
                [(ngModel)]="bitacoraFormData.presion_arterial"
                required
                placeholder="Ej. 120/80"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="observaciones">Observaciones adicionales</label>
              <textarea
                id="observaciones"
                name="observaciones"
                [(ngModel)]="bitacoraFormData.observaciones"
                rows="3"
                required
                placeholder="Notas relevantes de la consulta"
              ></textarea>
          </div>

          <button class="btn-primary" type="submit" [disabled]="isSubmittingBitacora || bitacoraForm.invalid">
            {{ isSubmittingBitacora ? 'Guardando...' : 'Guardar bit√°cora' }}
          </button>
        </form>
      </div>

      <div class="bitacoras-container">
        <ng-container *ngIf="!isLoadingBitacoras; else loadingBitacoras">
          <div *ngIf="bitacorasError" class="alert error">{{ bitacorasError }}</div>

          <div *ngIf="!bitacorasError && bitacoras.length === 0" class="placeholder-card">
            <h3>No hay bit√°coras registradas a√∫n</h3>
            <p>Registra la informaci√≥n de la consulta para que el alumno pueda consultarla.</p>
          </div>

          <div *ngIf="bitacoras.length > 0" class="bitacoras-layout">
            <article *ngFor="let bitacora of bitacoras" class="data-card bitacora-card">
              <header class="card-header">
                <div class="card-title">
                  <h4>{{ bitacora.alumno?.nombre }} {{ bitacora.alumno?.apellido }}</h4>
                  <p class="card-caption" *ngIf="bitacora.cita">
                    {{ formatDateDisplay(bitacora.cita.fecha_cita) }} ¬∑ {{ formatTime(bitacora.cita.hora_cita) }} hrs
                  </p>
                </div>
                <span class="badge-pill badge-success">Consulta atendida</span>
              </header>

              <div class="card-meta">
                <span class="meta-item">
                  Registrada el {{ formatBitacoraDate(bitacora.created_at) }}
                </span>
              </div>

              <div class="card-body">
                <dl class="details-list">
                  <div class="detail-item" *ngIf="bitacora.diagnostico">
                    <dt>Diagn√≥stico</dt>
                    <dd>{{ bitacora.diagnostico }}</dd>
                  </div>
                  <div class="detail-item" *ngIf="bitacora.tratamiento">
                    <dt>Tratamiento</dt>
                    <dd>{{ bitacora.tratamiento }}</dd>
                  </div>
                  <div class="detail-item" *ngIf="bitacora.observaciones">
                    <dt>Observaciones</dt>
                    <dd>{{ bitacora.observaciones }}</dd>
                  </div>
                </dl>

              <div class="metrics-row" *ngIf="bitacora.peso || bitacora.altura || bitacora.temperatura || bitacora.presion_arterial">
                <span class="metric-chip" *ngIf="bitacora.peso">‚öñÔ∏è Peso: {{ bitacora.peso }}</span>
                <span class="metric-chip" *ngIf="bitacora.altura">üìè Altura: {{ bitacora.altura }}</span>
                <span class="metric-chip" *ngIf="bitacora.temperatura">üå°Ô∏è Temp: {{ bitacora.temperatura }}</span>
                <span class="metric-chip" *ngIf="bitacora.presion_arterial">ü©∫ Presi√≥n: {{ bitacora.presion_arterial }}</span>
              </div>

              <div class="card-actions">
                <button class="btn-secondary" type="button" (click)="startEditBitacora(bitacora)">
                  Editar bit√°cora
                </button>
              </div>
            </div>
          </article>
          </div>
        </ng-container>
        <ng-template #loadingBitacoras>
          <div class="placeholder-card">Cargando bit√°coras...</div>
        </ng-template>
      </div>
    </section>

    <!-- Secci√≥n: Recetas -->
    <section *ngIf="activeSection === 'recetas'" class="content-section">
      <div class="section-header">
        <h2>Gesti√≥n de Recetas</h2>
        <button class="btn-primary" (click)="toggleRecetaForm()">
          {{ showRecetaForm ? 'Cerrar formulario' : 'Registrar Receta' }}
        </button>
      </div>

      <div *ngIf="recetaMessage" class="alert">
        {{ recetaMessage }}
      </div>

      <div *ngIf="showRecetaForm" class="form-card">
        <form #recetaForm="ngForm" (ngSubmit)="onCreateReceta(recetaForm)">
          <div class="form-grid">
            <div class="form-group">
              <label for="citaReceta">Cita atendida</label>
              <select
                id="citaReceta"
                name="cita_id"
                [(ngModel)]="recetaFormData.cita_id"
                required
                (ngModelChange)="onRecetaCitaChange($event)"
                [disabled]="editingRecetaId !== null"
              >
                <option value="" disabled selected>Selecciona una cita atendida</option>
                <option *ngFor="let cita of availableCitasForReceta" [value]="cita.id">
                  {{ formatDateDisplay(cita.fecha_cita) }} - {{ cita.hora_cita }} hrs ({{ cita.alumno?.nombre }} {{ cita.alumno?.apellido }})
                </option>
              </select>
            </div>
            <div class="form-group">
              <label for="fechaEmision">Fecha de emisi√≥n</label>
              <input
                type="date"
                id="fechaEmision"
                name="fecha_emision"
                [(ngModel)]="recetaFormData.fecha_emision"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label for="medicamentos">Medicamentos recetados</label>
            <textarea
              id="medicamentos"
              name="medicamentos"
              [(ngModel)]="recetaFormData.medicamentos"
              rows="3"
              required
              placeholder="Nombre comercial, presentaci√≥n y dosis"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="indicaciones">Indicaciones</label>
            <textarea
              id="indicaciones"
              name="indicaciones"
              [(ngModel)]="recetaFormData.indicaciones"
              rows="3"
              required
              placeholder="Instrucciones para el paciente"
            ></textarea>
          </div>

          <button class="btn-primary" type="submit" [disabled]="isSubmittingReceta || recetaForm.invalid">
            {{ isSubmittingReceta ? 'Guardando...' : 'Guardar receta' }}
          </button>
        </form>
      </div>

      <div class="recetas-container">
        <ng-container *ngIf="!isLoadingRecetas; else loadingRecetas">
          <div *ngIf="recetasError" class="alert error">{{ recetasError }}</div>

          <div *ngIf="!recetasError && recetas.length === 0" class="placeholder-card">
            <h3>No hay recetas registradas a√∫n</h3>
            <p>Registra una receta para que el alumno pueda consultarla en su perfil.</p>
          </div>

          <div *ngIf="recetas.length > 0" class="recetas-layout">
            <article *ngFor="let receta of recetas" class="data-card receta-card">
              <header class="card-header">
                <div class="card-title">
                  <h4>{{ receta.alumno?.nombre }} {{ receta.alumno?.apellido }}</h4>
                  <p class="card-caption" *ngIf="receta.cita">
                    {{ formatDateDisplay(receta.cita.fecha_cita) }} ¬∑ {{ formatTime(receta.cita.hora_cita) }} hrs
                  </p>
                </div>
                <span class="badge-pill badge-info">Emitida {{ formatRecetaDate(receta.fecha_emision) }}</span>
              </header>

              <div class="card-body">
                <div class="detail-item">
                  <dt>Medicamentos recetados</dt>
                  <dd class="text-pre">{{ receta.medicamentos }}</dd>
                </div>
                <div class="detail-item" *ngIf="receta.indicaciones">
                  <dt>Indicaciones</dt>
                  <dd class="text-pre">{{ receta.indicaciones }}</dd>
                </div>

                <div class="card-actions">
                  <button class="btn-secondary" type="button" (click)="startEditReceta(receta)">
                    Editar receta
                  </button>
                </div>
              </div>
            </article>
          </div>
        </ng-container>
        <ng-template #loadingRecetas>
          <div class="placeholder-card">Cargando recetas...</div>
        </ng-template>
      </div>
    </section>

  </main>
</div>