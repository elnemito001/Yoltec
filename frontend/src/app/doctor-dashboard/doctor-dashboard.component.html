<div class="doctor-dashboard">
  <!-- Encabezado -->
  <header class="dashboard-header">
    <div class="header-content">
      <h1>Consultorio M√©dico</h1>
      <div class="user-info">
        <span>Bienvenido, {{ doctorName }}</span>
        <button class="logout-btn" (click)="logout()">Cerrar Sesi√≥n</button>
      </div>
    </div>
    
    <!-- Navegaci√≥n -->
    <nav class="dashboard-nav">
      <button 
        [class.active]="activeSection === 'inicio'" 
        (click)="setActiveSection('inicio')"
        class="nav-button">
        Inicio
      </button>
      <button 
        [class.active]="activeSection === 'citas'" 
        (click)="setActiveSection('citas')"
        class="nav-button">
        Citas
      </button>
      <button 
        [class.active]="activeSection === 'bitacoras'" 
        (click)="setActiveSection('bitacoras')"
        class="nav-button">
        Bit√°coras
      </button>
      <button 
        [class.active]="activeSection === 'recetas'" 
        (click)="setActiveSection('recetas')"
        class="nav-button">
        Recetas
      </button>
    </nav>
  </header>

  <!-- Contenido Principal -->
  <main class="dashboard-content">
    
    <!-- Secci√≥n: Inicio -->
    <section *ngIf="activeSection === 'inicio'" class="content-section">
      <div class="welcome-card">
        <h2>Panel del Doctor</h2>
        <p>Bienvenido {{ doctorName }}, desde aqu√≠ puedes gestionar tus consultas, pacientes y registros m√©dicos.</p>
        
        <div class="quick-stats">
          <div class="stat-card">
            <h3>Citas del D√≠a</h3>
            <p class="stat-value">{{ todayAppointments }}</p>
            <p class="stat-detail">Programadas para hoy</p>
          </div>
          <div class="stat-card">
            <h3>Pacientes Atendidos</h3>
            <p class="stat-value">{{ patientsAttended }}</p>
            <p class="stat-detail">Historial reciente</p>
          </div>
          <div class="stat-card">
            <h3>Citas Pendientes</h3>
            <p class="stat-value">{{ pendingBitacoras }}</p>
            <p class="stat-detail">Requieren atenci√≥n</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Secci√≥n: Citas -->
    <section *ngIf="activeSection === 'citas'" class="content-section">
      <div class="section-header">
        <h2>Gesti√≥n de Citas</h2>
        <button class="btn-primary" (click)="toggleCreateForm()">
          {{ showCreateForm ? 'Cerrar formulario' : 'Agendar Nueva Cita' }}
        </button>
      </div>

      <div *ngIf="submitMessage" class="alert">
        {{ submitMessage }}
      </div>

      <div *ngIf="showCreateForm" class="form-card">
        <form #createCitaForm="ngForm" (ngSubmit)="onCreateCita(createCitaForm)">
          <div class="form-grid">
            <div class="form-group">
              <label for="numeroControl">N√∫mero de control del alumno</label>
              <input
                type="text"
                id="numeroControl"
                name="numero_control"
                [(ngModel)]="createFormData.numero_control"
                required
                placeholder="Ej. A12345678"
              />
            </div>
            <div class="form-group">
              <label for="fechaCita">Fecha de la cita</label>
              <input
                type="date"
                id="fechaCita"
                name="fecha_cita"
                [(ngModel)]="createFormData.fecha_cita"
                required
                min="{{ today }}"
              />
            </div>
            <div class="form-group">
              <label for="horaCita">Hora</label>
              <input
                type="time"
                id="horaCita"
                name="hora_cita"
                [(ngModel)]="createFormData.hora_cita"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label for="motivo">Motivo</label>
            <textarea
              id="motivo"
              name="motivo"
              [(ngModel)]="createFormData.motivo"
              rows="3"
              placeholder="Describe el motivo de la consulta"
            ></textarea>
          </div>

          <button class="btn-primary" type="submit" [disabled]="isSubmitting || createCitaForm.invalid">
            {{ isSubmitting ? 'Agendando...' : 'Guardar cita' }}
          </button>
        </form>
      </div>

      <div class="citas-container">
        <ng-container *ngIf="!isLoadingCitas; else loadingCitas">
          <div *ngIf="citasError" class="alert error">{{ citasError }}</div>

          <div *ngIf="!citasError && citas.length === 0" class="placeholder-card">
            <h3>A√∫n no tienes citas programadas</h3>
            <p>Agrega nuevas citas usando el bot√≥n "Agendar Nueva Cita".</p>
          </div>

          <div *ngIf="citas.length > 0" class="cards-grid">
            <div *ngFor="let cita of citas" class="cita-card" [class.cancelada]="cita.estatus === 'cancelada'">
              <div class="cita-header">
                <h3>{{ formatDateDisplay(cita.fecha_cita) }}</h3>
                <span class="estatus" [class.atendida]="cita.estatus === 'atendida'" [class.cancelada]="cita.estatus === 'cancelada'">{{ cita.estatus }}</span>
              </div>
              <p class="hora">{{ cita.hora_cita }} hrs</p>
              <p class="motivo" *ngIf="cita.motivo">{{ cita.motivo }}</p>
              <p class="alumno" *ngIf="cita.alumno">Alumno: {{ cita.alumno.nombre }} {{ cita.alumno.apellido }}</p>

              <div class="card-actions">
                <button class="btn-secondary" (click)="onCancelCita(cita)" [disabled]="isSubmitting || cita.estatus !== 'programada'">
                  {{ isSubmitting ? 'Procesando...' : 'Cancelar' }}
                </button>
                <button class="btn-primary" (click)="onMarkAsAttended(cita)" [disabled]="isSubmitting || cita.estatus !== 'programada'">
                  {{ isSubmitting ? 'Procesando...' : 'Marcar atendida' }}
                </button>
              </div>
            </div>
          </div>
        </ng-container>
        <ng-template #loadingCitas>
          <div class="placeholder-card">Cargando lista de citas...</div>
        </ng-template>
      </div>
    </section>

    <!-- Secci√≥n: Bit√°coras -->
    <section *ngIf="activeSection === 'bitacoras'" class="content-section">
      <div class="section-header">
        <h2>Bit√°coras M√©dicas</h2>
        <button class="btn-primary" (click)="toggleBitacoraForm()">
          {{ showBitacoraForm ? 'Cerrar formulario' : 'Registrar Bit√°cora' }}
        </button>
      </div>

      <div *ngIf="bitacoraMessage" class="alert">
        {{ bitacoraMessage }}
      </div>

      <div *ngIf="showBitacoraForm" class="form-card">
        <form #bitacoraForm="ngForm" (ngSubmit)="onCreateBitacora(bitacoraForm)">
          <div class="form-grid">
            <div class="form-group">
              <label for="citaAsociada">Cita atendida</label>
              <select
                id="citaAsociada"
                name="cita_id"
                [(ngModel)]="bitacoraFormData.cita_id"
                required
              >
                <option value="" disabled selected>Selecciona una cita atendida</option>
                <option *ngFor="let cita of availableCitasForBitacora" [value]="cita.id">
                  {{ formatDateDisplay(cita.fecha_cita) }} - {{ cita.hora_cita }} hrs ({{ cita.alumno?.nombre }} {{ cita.alumno?.apellido }})
                </option>
              </select>
            </div>
            <div class="form-group">
              <label for="diagnostico">Diagn√≥stico</label>
              <textarea
                id="diagnostico"
                name="diagnostico"
                [(ngModel)]="bitacoraFormData.diagnostico"
                rows="2"
                placeholder="Describe el diagn√≥stico"
              ></textarea>
            </div>
            <div class="form-group">
              <label for="tratamiento">Tratamiento</label>
              <textarea
                id="tratamiento"
                name="tratamiento"
                [(ngModel)]="bitacoraFormData.tratamiento"
                rows="2"
                placeholder="Describe el tratamiento"
              ></textarea>
            </div>
          </div>

          <div class="form-grid small-grid">
            <div class="form-group">
              <label for="peso">Peso</label>
              <input
                type="text"
                id="peso"
                name="peso"
                [(ngModel)]="bitacoraFormData.peso"
                placeholder="Ej. 70 kg"
              />
            </div>
            <div class="form-group">
              <label for="altura">Altura</label>
              <input
                type="text"
                id="altura"
                name="altura"
                [(ngModel)]="bitacoraFormData.altura"
                placeholder="Ej. 1.70 m"
              />
            </div>
            <div class="form-group">
              <label for="temperatura">Temperatura</label>
              <input
                type="text"
                id="temperatura"
                name="temperatura"
                [(ngModel)]="bitacoraFormData.temperatura"
                placeholder="Ej. 36.5 ¬∞C"
              />
            </div>
            <div class="form-group">
              <label for="presion">Presi√≥n arterial</label>
              <input
                type="text"
                id="presion"
                name="presion_arterial"
                [(ngModel)]="bitacoraFormData.presion_arterial"
                placeholder="Ej. 120/80"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="observaciones">Observaciones adicionales</label>
            <textarea
              id="observaciones"
              name="observaciones"
              [(ngModel)]="bitacoraFormData.observaciones"
              rows="3"
              placeholder="Notas relevantes de la consulta"
            ></textarea>
          </div>

          <button class="btn-primary" type="submit" [disabled]="isSubmittingBitacora || bitacoraForm.invalid">
            {{ isSubmittingBitacora ? 'Guardando...' : 'Guardar bit√°cora' }}
          </button>
        </form>
      </div>

      <div class="bitacoras-container">
        <ng-container *ngIf="!isLoadingBitacoras; else loadingBitacoras">
          <div *ngIf="bitacorasError" class="alert error">{{ bitacorasError }}</div>

          <div *ngIf="!bitacorasError && bitacoras.length === 0" class="placeholder-card">
            <h3>No hay bit√°coras registradas a√∫n</h3>
            <p>Registra la informaci√≥n de la consulta para que el alumno pueda consultarla.</p>
          </div>

          <div *ngIf="bitacoras.length > 0" class="cards-grid">
            <div *ngFor="let bitacora of bitacoras" class="bitacora-card">
              <div class="bitacora-header">
                <h3>{{ bitacora.alumno?.nombre }} {{ bitacora.alumno?.apellido }}</h3>
                <span class="bitacora-date">{{ formatBitacoraDate(bitacora.created_at) }}</span>
              </div>
              <p class="bitacora-detail"><strong>Cita:</strong> {{ bitacora.cita?.fecha_cita | date:'mediumDate' }} - {{ bitacora.cita?.hora_cita }} hrs</p>
              <p class="bitacora-detail" *ngIf="bitacora.diagnostico"><strong>Diagn√≥stico:</strong> {{ bitacora.diagnostico }}</p>
              <p class="bitacora-detail" *ngIf="bitacora.tratamiento"><strong>Tratamiento:</strong> {{ bitacora.tratamiento }}</p>
              <p class="bitacora-detail" *ngIf="bitacora.observaciones"><strong>Observaciones:</strong> {{ bitacora.observaciones }}</p>

              <div class="bitacora-metrics">
                <span *ngIf="bitacora.peso">‚öñÔ∏è Peso: {{ bitacora.peso }}</span>
                <span *ngIf="bitacora.altura">üìè Altura: {{ bitacora.altura }}</span>
                <span *ngIf="bitacora.temperatura">üå°Ô∏è Temp: {{ bitacora.temperatura }}</span>
                <span *ngIf="bitacora.presion_arterial">ü©∫ Presi√≥n: {{ bitacora.presion_arterial }}</span>
              </div>
            </div>
          </div>
        </ng-container>
        <ng-template #loadingBitacoras>
          <div class="placeholder-card">Cargando bit√°coras...</div>
        </ng-template>
      </div>
    </section>

    <!-- Secci√≥n: Recetas -->
    <section *ngIf="activeSection === 'recetas'" class="content-section">
      <div class="section-header">
        <h2>Gesti√≥n de Recetas</h2>
        <button class="btn-primary" (click)="toggleRecetaForm()">
          {{ showRecetaForm ? 'Cerrar formulario' : 'Registrar Receta' }}
        </button>
      </div>

      <div *ngIf="recetaMessage" class="alert">
        {{ recetaMessage }}
      </div>

      <div *ngIf="showRecetaForm" class="form-card">
        <form #recetaForm="ngForm" (ngSubmit)="onCreateReceta(recetaForm)">
          <div class="form-grid">
            <div class="form-group">
              <label for="citaReceta">Cita atendida</label>
              <select
                id="citaReceta"
                name="cita_id"
                [(ngModel)]="recetaFormData.cita_id"
                required
              >
                <option value="" disabled selected>Selecciona una cita atendida</option>
                <option *ngFor="let cita of availableCitasForReceta" [value]="cita.id">
                  {{ formatDateDisplay(cita.fecha_cita) }} - {{ cita.hora_cita }} hrs ({{ cita.alumno?.nombre }} {{ cita.alumno?.apellido }})
                </option>
              </select>
            </div>
            <div class="form-group">
              <label for="fechaEmision">Fecha de emisi√≥n</label>
              <input
                type="date"
                id="fechaEmision"
                name="fecha_emision"
                [(ngModel)]="recetaFormData.fecha_emision"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label for="medicamentos">Medicamentos recetados</label>
            <textarea
              id="medicamentos"
              name="medicamentos"
              [(ngModel)]="recetaFormData.medicamentos"
              rows="3"
              required
              placeholder="Nombre comercial, presentaci√≥n y dosis"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="indicaciones">Indicaciones</label>
            <textarea
              id="indicaciones"
              name="indicaciones"
              [(ngModel)]="recetaFormData.indicaciones"
              rows="3"
              placeholder="Instrucciones para el paciente"
            ></textarea>
          </div>

          <button class="btn-primary" type="submit" [disabled]="isSubmittingReceta || recetaForm.invalid">
            {{ isSubmittingReceta ? 'Guardando...' : 'Guardar receta' }}
          </button>
        </form>
      </div>

      <div class="recetas-container">
        <ng-container *ngIf="!isLoadingRecetas; else loadingRecetas">
          <div *ngIf="recetasError" class="alert error">{{ recetasError }}</div>

          <div *ngIf="!recetasError && recetas.length === 0" class="placeholder-card">
            <h3>No hay recetas registradas a√∫n</h3>
            <p>Registra una receta para que el alumno pueda consultarla en su perfil.</p>
          </div>

          <div *ngIf="recetas.length > 0" class="cards-grid">
            <div *ngFor="let receta of recetas" class="receta-card">
              <div class="receta-header">
                <h3>{{ receta.alumno?.nombre }} {{ receta.alumno?.apellido }}</h3>
                <span class="receta-date">{{ formatRecetaDate(receta.fecha_emision) }}</span>
              </div>
              <p class="receta-detail"><strong>Cita:</strong> {{ receta.cita?.fecha_cita | date:'mediumDate' }} - {{ receta.cita?.hora_cita }} hrs</p>
              <p class="receta-detail"><strong>Medicamentos:</strong></p>
              <p class="receta-text">{{ receta.medicamentos }}</p>
              <p class="receta-detail" *ngIf="receta.indicaciones"><strong>Indicaciones:</strong></p>
              <p class="receta-text" *ngIf="receta.indicaciones">{{ receta.indicaciones }}</p>
            </div>
          </div>
        </ng-container>
        <ng-template #loadingRecetas>
          <div class="placeholder-card">Cargando recetas...</div>
        </ng-template>
      </div>
    </section>

  </main>
</div>